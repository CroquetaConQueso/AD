<div class="card">
  <div class="card-header">
    <h2>{{ isViewMode ? 'Detalles del Tratamiento' : (isEdit ? 'Editar Tratamiento' : 'Nuevo Tratamiento') }}</h2>
  </div>
  
  <div class="card-body">
    
    <div *ngIf="isLoading" class="loading-msg">
      <p>Cargando datos...</p>
    </div>

    <div *ngIf="debugMsg && debugMsg.startsWith('Error')" class="alert alert-danger">
      {{ debugMsg }}
    </div>

    <form *ngIf="!isLoading" (ngSubmit)="save()">
      
      <div class="form-group">
        <label for="desc">Descripción del Tratamiento <span class="required">*</span></label>
        <input 
          type="text" 
          id="desc"
          class="form-control" 
          [(ngModel)]="treatment.description" 
          name="description" 
          [readonly]="isViewMode" 
          placeholder="Ej: Revisión anual, Control de tensión..." 
          required
        />
      </div>

      <div class="form-group">
        <label for="patient">Paciente <span class="required">*</span></label>
        <select 
          id="patient"
          class="form-control" 
          [(ngModel)]="treatment.patientId" 
          name="patientId" 
          [disabled]="isViewMode" 
          required>
          <option value="" disabled selected>-- Selecciona un Paciente --</option>
          <option *ngFor="let p of patients" [value]="p.id">
            {{ p.name }} ({{ p.age }} años)
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="staff">Doctor/a o Enfermero/a <span class="required">*</span></label>
        <select 
          id="staff"
          class="form-control" 
          [(ngModel)]="treatment.staffId" 
          name="staffId" 
          [disabled]="isViewMode" 
          required>
          <option value="" disabled selected>-- Selecciona Personal --</option>
          <option *ngFor="let s of staffList" [value]="s.id">
            {{ s.name }} - {{ s.role }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="medicine">Medicina Recetada</label>
        <select 
          id="medicine"
          class="form-control" 
          [(ngModel)]="treatment.medicineId" 
          name="medicineId" 
          [disabled]="isViewMode">
          <option value="">-- Ninguna --</option>
          <option *ngFor="let m of medicines" [value]="m.id">
            {{ m.name }} (Stock: {{ m.quantity }})
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="date">Fecha de Inicio <span class="required">*</span></label>
        <input 
          type="date" 
          id="date"
          class="form-control" 
          [(ngModel)]="treatment.date" 
          name="date" 
          [readonly]="isViewMode" 
          required
        />
      </div>

      <div class="form-group">
        <label for="notes">Notas / Observaciones</label>
        <textarea 
          id="notes"
          class="form-control" 
          [(ngModel)]="treatment.notes" 
          name="notes" 
          [readonly]="isViewMode" 
          rows="3"
          placeholder="Escribe aquí cualquier detalle clínico adicional...">
        </textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancel()">
          {{ isViewMode ? 'Volver' : 'Cancelar' }}
        </button>
        <button type="submit" class="btn btn-primary" *ngIf="!isViewMode" [disabled]="!treatment.description || !treatment.patientId || !treatment.staffId">
          Guardar Tratamiento
        </button>
      </div>

    </form>
  </div>
</div>